<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>게시글 수정</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .preview-image {
            max-width: 200px;
            max-height: 200px;
            margin-top: 10px;
            border: 1px solid #ddd;
        }
    </style>
</head>
<body>
    <div th:replace="~{fragments/header :: header}"></div>

    <div class="container mt-4">
        <h1>게시글 수정</h1>
        <hr>
        <form th:action="@{/board/update}" th:object="${board}" method="post" enctype="multipart/form-data" onsubmit="return prepareModifySubmit();">
            <input type="hidden" th:field="*{id}">

            <div class="mb-3">
                <label for="category" class="form-label">카테고리:</label>
                <select id="category" th:field="*{category}" class="form-select" onchange="updateSubcategories()">
                    <option value="">카테고리 선택</option>
                    <option th:each="cat : ${allCategories}" th:value="${cat}" th:text="${cat}"
                            th:selected="${selectedCategory != null and selectedCategory == cat}">
                    </option>
                </select>
            </div>

            <div class="mb-3">
                <label for="subcategory" class="form-label">서브카테고리:</label>
                <select id="subcategory" th:field="*{subcategory}" class="form-select" onchange="updateCertificates()">
                    <option value="">서브카테고리 선택</option>
                    <th:block th:if="${subcategories != null}">
                        <option th:each="sub : ${subcategories}" th:value="${sub}" th:text="${sub}"
                                th:selected="${selectedSubcategory != null and selectedSubcategory == sub}">
                        </option>
                    </th:block>
                </select>
            </div>

            <div class="mb-3">
                <label for="certificateName" class="form-label">자격증명:</label>
                <select id="certificateName" th:field="*{certificateName}" class="form-select">
			    <option value="">자격증명 선택</option>
			    <th:block th:if="${certificates != null}">
			        <option th:each="cert : ${certificates}"
                			th:value="${cert}" th:text="${cert}"  th:selected="${selectedCertificate != null and selectedCertificate == cert}"> </option>
    </th:block>
</select>
            </div>

            <div class="mb-3">
                <label for="title" class="form-label">제목:</label>
                <input type="text" id="title" th:field="*{title}" class="form-control" required>
            </div>

            <div class="mb-3">
			    <label for="content" class="form-label">내용:</label>
			    <input type="hidden" id="content" th:field="*{content}">
			
			    <div id="editor" contenteditable="true" class="form-control" style="min-height: 150px;">
			        <span th:utext="${board.content}"></span>
			    </div>
			    <div class="mb-2">
        <label for="colorPicker" class="form-label">글자색 선택:</label>
        <input type="color" id="colorPicker" class="form-control form-control-color" value="#000000" title="글자색 선택">
    </div>
			</div>

            <div class="mb-3">
                <label for="image" class="form-label">이미지:</label>
                <input type="file" id="image" name="image" class="form-control">
                <div th:if="${board.imagePath != null and !board.imagePath.isEmpty()}">
                    <p class="mt-2">현재 이미지:</p>
                    <img th:src="${board.imagePath}" alt="기존 이미지" class="preview-image" id="currentImagePreview">
                    <br>
                    <input type="checkbox" id="deleteImage" name="deleteImage" value="true">
                    <label for="deleteImage">기존 이미지 삭제</label>
                </div>
                <img id="imagePreview" src="#" alt="이미지 미리보기" class="preview-image" style="display: none;">
            </div>

            <button type="submit" class="btn btn-primary">수정 완료</button>
            <a th:href="@{/board/{id}(id=${board.id})}" class="btn btn-secondary">취소</a>
        </form>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const categorySelect = document.getElementById('category');
        const subcategorySelect = document.getElementById('subcategory');
        const certificateSelect = document.getElementById('certificateName'); // name 속성 확인

        const initialCategory = /*[[${selectedCategory}]]*/ '';
        const initialSubcategory = /*[[${selectedSubcategory}]]*/ '';
        const initialCertificate = /*[[${selectedCertificate}]]*/ '';

        // 모델에서 모든 카테고리, 초기 서브카테고리, 초기 자격증 목록을 받습니다.
        const allCategories = /*[[${categories}]]*/ [];
        const initialSubcategories = /*[[${subcategories}]]*/ [];
        const initialCertificates = /*[[${certificates}]]*/ [];

        // 카테고리 드롭다운 채우기 (서버에서 받은 allCategories 사용)
        allCategories.forEach(cat => {
            const option = document.createElement('option');
            option.value = cat;
            option.textContent = cat;
            if (cat === initialCategory) {
                option.selected = true;
            }
            categorySelect.appendChild(option);
        });

        // 초기 서브카테고리 드롭다운 채우기
        initialSubcategories.forEach(sub => {
            const option = document.createElement('option');
            option.value = sub;
            option.textContent = sub;
            if (sub === initialSubcategory) {
                option.selected = true;
            }
            subcategorySelect.appendChild(option);
        });

        // 초기 자격증 드롭다운 채우기
        initialCertificates.forEach(cert => {
            const option = document.createElement('option');
            option.value = cert;
            option.textContent = cert;
            if (cert === initialCertificate) {
                option.selected = true;
            }
            certificateSelect.appendChild(option);
        });


        categorySelect.addEventListener('change', function() {
            updateSubcategories(this.value, null, null);
        });

        subcategorySelect.addEventListener('change', function() {
            updateCertificates(categorySelect.value, this.value, null);
        });

        function updateSubcategories(selectedCategory, initialSubcategoryValue, initialCertificateValue) {
            subcategorySelect.innerHTML = '<option value="">-- 서브카테고리 선택 --</option>';
            certificateSelect.innerHTML = '<option value="">-- 자격증 선택 --</option>';

            if (selectedCategory) {
                fetch(`/api/subcategories?category=${selectedCategory}`)
                    .then(response => response.json())
                    .then(data => {
                        data.forEach(sub => {
                            const option = document.createElement('option');
                            option.value = sub;
                            option.textContent = sub;
                            if (sub === initialSubcategoryValue) {
                                option.selected = true;
                            }
                            subcategorySelect.appendChild(option);
                        });
                        const currentSub = subcategorySelect.value || initialSubcategoryValue;
                        updateCertificates(selectedCategory, currentSub, initialCertificateValue);
                    })
                    .catch(error => console.error('Error loading subcategories:', error));
            }
        }

        function updateCertificates(selectedCategory, selectedSubcategory, initialCertificateValue) {
            certificateSelect.innerHTML = '<option value="">-- 자격증 선택 --</option>';

            if (selectedCategory && selectedSubcategory) {
                fetch(`/api/certificates?category=${selectedCategory}&subcategory=${selectedSubcategory}`)
                    .then(response => response.json())
                    .then(data => {
                        data.forEach(certName => {
                            const option = document.createElement('option');
                            option.value = certName;
                            option.textContent = certName;
                            if (certName === initialCertificateValue) {
                                option.selected = true;
                            }
                            certificateSelect.appendChild(option);
                        });
                    })
                    .catch(error => console.error('Error loading certificates:', error));
            }
        }
    });
</script>
</body>
</html>